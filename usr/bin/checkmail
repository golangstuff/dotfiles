#!/bin/sh
# vim:fdm=marker

maildir=$HOME/mail
mailbox=${maildir}/inbox

echo "`date +%x_%X`: I start running now!" >> ${maildir}/log/runlog

sh ${maildir}/run-getmail.sh

for amail in `ls ${mailbox}/new/`; do
    msmtp myemail@example.com < ${mailbox}/new/${amail};
    if [ "$?" -ne "0" ]; then
        echo "`date +%x_%X`: ERROR sending ${amail}, not sending!" >> ${maildir}/log/errorlog;
        echo "`date +%x_%X`: ERROR sending ${amail}, not sending!" | mutt -s "mail sending error" myemail.bak@gmail.com;
        mv ${mailbox}/new/${amail} ${maildir}/fail/new/;
    else
        echo "`date +%x_%X`: SENT: ${amail}." >> ${maildir}/log/sentlog;
        mv ${mailbox}/new/${amail} ${mailbox}/cur/;
        sleep 1;
    fi
done

